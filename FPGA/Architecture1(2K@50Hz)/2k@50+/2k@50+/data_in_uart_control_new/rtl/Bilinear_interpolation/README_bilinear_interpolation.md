# 双线性插值模块说明文档

## 模块概述
`bilinear_interpolation.v` 是一个用于图像缩放的硬件加速模块,支持任意分辨率的实时缩放。

## 主要特性
- **双时钟域设计**: 输入(clk_in1)和输出(clk_in2)采用不同时钟域
- **动态分辨率配置**: 支持运行时修改目标分辨率
- **双模式输出**: 
  - 模式0: 最近邻插值(速度快,质量一般)
  - 模式1: 双线性插值(质量高,平滑过渡)
- **10级流水线架构**: 保证高吞吐量和稳定性

## 模块结构

### 1. 动态分辨率配置模块 (c1~c4阶段)
**功能**: 在每帧结束时更新目标分辨率并计算缩放比例

**主要步骤**:
- 检测输出场同步信号的下降沿(帧结束)
- 锁存新的目标分辨率参数
- 计算X和Y方向的缩放比例: `RATIO = (源尺寸 / 目标尺寸) × 2^16`
- 使用除法器IP核完成定点数计算

**关键信号**:
```verilog
input  [11:0] c_dst_img_width   // 动态输入的目标宽度
input  [11:0] c_dst_img_height  // 动态输入的目标高度
reg    [16:0] C_X_RATIO         // X方向缩放比例(Q16定点数)
reg    [16:0] C_Y_RATIO         // Y方向缩放比例(Q16定点数)
```

### 2. 输入图像处理模块 (clk_in1时钟域)
**功能**: 接收输入图像并存储到BRAM中

**存储策略**:
- 使用4个双端口BRAM存储输入图像
- BRAM1和BRAM2分别存储奇偶行
- 每个BRAM又分为偶数和奇数地址段
- 行地址编码: `{行号[2:1], 列号[9:0]}`

**行列计数器**:
- `img_vs_cnt`: 垂直行计数器 (0 ~ HEIGHT-1)
- `img_hs_cnt`: 水平像素计数器 (0 ~ WIDTH-1)

**FIFO跨时钟域**:
- 异步FIFO传输行号信息
- 用于同步输入和输出时钟域

### 3. 输出控制状态机 (clk_in2时钟域)
**状态定义**:
```
S_IDLE      - 空闲状态,等待FIFO非空
S_Y_LOAD    - 判断是否有足够的源数据
S_BRAM_ADDR - 计算地址并输出一行数据
S_Y_INC     - Y坐标递增
S_RD_FIFO   - 读取FIFO中的行号
```

**坐标计算**:
- `x_dec`, `y_dec`: 定点坐标 [26:16]整数,[15:0]小数
- 每输出一个像素: `x_dec += C_X_RATIO`
- 每输出一行: `y_dec += C_Y_RATIO`

### 4. 双线性插值流水线 (10级)

#### **c1阶段**: 坐标分解
- 提取整数部分: `x_int = x_dec[25:16]`
- 提取小数部分: `x_fra = x_dec[15:0]`
- 计算补数: `inv_x_fra = 1 - x_fra`

#### **c2阶段**: 权重计算
- 计算BRAM地址: `addr = {y_int[2:1], 10'b0} + x_int`
- 计算4个角点的权重:
  ```
  frac_00 = (1-dx) × (1-dy)  // 左上角
  frac_01 = dx × (1-dy)      // 右上角
  frac_10 = (1-dx) × dy      // 左下角
  frac_11 = dx × dy          // 右下角
  ```
- 检测边界像素

#### **c3阶段**: BRAM读地址设置
- 根据Y坐标奇偶性选择BRAM组
- 设置4个BRAM读地址以获取2×2像素块

#### **c4阶段**: 流水线延迟
- 传递权重和标志信号

#### **c5阶段**: 像素读取
- 从BRAM读取4个相邻像素
- 根据奇偶模式重新排列

#### **c6阶段**: 边界扩展
- 当坐标到达图像边界时,复制边界像素
- 避免读取越界

#### **c7阶段**: 加权乘法
- 计算加权像素值: `weighted_pixel = weight × pixel`
- 双线性插值公式:
  ```
  f(x,y) = f00×(1-dx)×(1-dy) + f01×dx×(1-dy) 
         + f10×(1-dx)×dy + f11×dx×dy
  ```
- 最近邻模式: 直接选择最接近的像素

#### **c8阶段**: 两两相加
- 上方两像素和: `tmp1 = gray_00 + gray_01`
- 下方两像素和: `tmp2 = gray_10 + gray_11`

#### **c9阶段**: 最终求和
- 插值结果: `result = tmp1 + tmp2`

#### **c10阶段**: 定点转整数
- 四舍五入: `gray = result[43:32] + result[31]`
- 饱和处理: 限制在0~255范围

### 5. 场同步扩展逻辑
**功能**: 在帧结束后延长场同步信号20个时钟周期

**原因**: 确保下游模块有足够时间处理帧结束事件

### 6. 输出信号生成
**输出信号**:
```verilog
post_img_vsync  // 场同步信号
post_img_href   // 行同步信号
post_img_gray   // 灰度数据输出
```

**模式选择**:
- `out_model = 0`: 输出最近邻插值结果
- `out_model = 1`: 输出双线性插值结果

## 关键参数

| 参数名称 | 默认值 | 说明 |
|---------|--------|------|
| C_SRC_IMG_WIDTH | 640 | 源图像宽度 |
| C_SRC_IMG_HEIGHT | 480 | 源图像高度 |
| c_dst_img_width | 动态 | 目标图像宽度(动态输入) |
| c_dst_img_height | 动态 | 目标图像高度(动态输入) |

## 资源占用估算
- **BRAM**: 4个双端口BRAM (存储4行×源图像宽度)
- **DSP**: 多个乘法器用于插值计算
- **逻辑单元**: 约3000~5000 LUT
- **除法器IP**: 2个(用于缩放比例计算)
- **FIFO**: 1个异步FIFO(深度取决于行数)

## 时序要求
- 输入时钟(clk_in1): 根据输入帧率确定
- 输出时钟(clk_in2): 必须足够高以支持目标帧率
- 最小输出时钟频率估算: `f_clk2 ≥ 目标宽度 × 目标高度 × 帧率 × 1.2`

## 使用限制
1. 源图像宽度必须 ≤ 1024 (受BRAM地址位宽限制)
2. 最大放大倍率: 约4倍(有特殊处理)
3. 缩小倍率无限制,但过度缩小会导致采样混叠

## 应用场景
- 视频缩放
- 图像分辨率转换
- 显示适配(不同屏幕尺寸)
- 数字变焦
- PIP(画中画)功能

## 优化建议
1. **提高性能**: 增加输出时钟频率
2. **降低延迟**: 减少流水线级数(牺牲频率)
3. **降低资源**: 采用时分复用代替空间并行
4. **改进质量**: 实现双三次插值(需要更多资源)
